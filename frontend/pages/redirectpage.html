<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        .font {
            font-family: proxima-nova, sans-serif;
            font-style: normal;
            font-weight: 100;
        }
    </style>

    <!-- Vue2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Flowbite -->
    <link rel="stylesheet" href="https://unpkg.com/flowbite@1.5.3/dist/flowbite.min.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Passage Library -->
    <script src="https://psg.so/web.js"></script>
    <!-- flowbite -->
    <script src="https://unpkg.com/flowbite@1.5.3/dist/flowbite.js"></script>
</head>

<body>

    <div id="main-container">
        <p>This is redirected page</p>
        <div>sign out button</div>

        <button
            class="relative inline-flex items-center justify-center p-0.5 mb-2 mr-2 overflow-hidden text-sm font-medium text-gray-900 rounded-lg group bg-gradient-to-br from-purple-600 to-blue-500 group-hover:from-purple-600 group-hover:to-blue-500 hover:text-white dark:text-white focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800">
            <span
                class="relative px-5 py-2.5 transition-all ease-in duration-75 bg-white dark:bg-gray-900 rounded-md group-hover:bg-opacity-0">
                Purple to blue
            </span>
        </button>
    </div>

    <script type="module">
        import { Passage } from 'https://cdn.passage.id/passage-js.js';

        window.isLoading = true;
        window.isAuthorized = false;
        window.username = '';

        (async () => {
            const psg = new Passage('E3hjWQlq03LsYPBMG1ESlWbQ');
            const user = psg.getCurrentUser();
            const userInfo = await user.userInfo();
            console.log(userInfo);

            if (!userInfo) {
                window.isLoading = false;
                return;
            }

            window.username = userInfo.email;
            
            try{
                const response = await fetch("/auth-backend", {
                    method: 'POST', 
                    headers: {
                        'Content-Type':  'application/json',
                    },
                    body: JSON.stringify({
                        email: userInfo.email, 
                        tt_username: userInfo.user_metadata.tiktok_username, 
                        authToken: localStorage.getItem("psg_auth_token"),
                    }),
                })
                const data = await response.json()
                if (data) {
                    // backend will return session variable or smth
                    console.log("Success: ", data)
                    window.isAuthorized = true;
                    window.isLoading = false;
                }
            }
            catch (error) {
                alert(error)
                window.isAuthorized = false;
                window.isLoading = false;
                // should redirect back to login page
            }
        })();
    </script>
</body>
<script>
    const vm = new Vue({
        el: '#main-container',
        data: {
            isLoading: window.isLoading,
            isAuthorized: window.isAuthorized,
            username: window.username
        },
        mounted: async function () {

        },
        methods: {

        },
        created() {

        }
    });
</script>
</html>